# API-002 — Build accounts and categories CRUD endpoints

## Что сделано

### 1. Базовая структура NestJS приложения

- Создан `tsconfig.json` для TypeScript компиляции с поддержкой декораторов.
- Реализован entry point `src/main.ts` с настройкой:
  - Global ValidationPipe для автоматической валидации.
  - CORS для Mini App.
  - Запуск сервера на порту из env (по умолчанию 3000).
- Создан корневой `AppModule`, объединяющий все модули приложения.

### 2. PrismaModule для работы с БД

- Создан `PrismaService` с composition pattern (вместо наследования) для работы с Prisma Client 7.x.
- Реализованы lifecycle hooks `onModuleInit` и `onModuleDestroy` для управления подключением.
- Proxy getters для доступа к моделям: `user`, `refreshSession`, `account`, `category`, `transaction`.
- PrismaModule сделан глобальным для использования во всех модулях.

### 3. AccountsModule (CRUD для счетов)

**Endpoints:**
- `GET /api/v1/accounts` — получение всех счетов пользователя.
- `POST /api/v1/accounts` — создание счета (валидация: name, currency ∈ {RUB, USD, EUR, KGS}, type ∈ {CASH, INVESTMENT}).
- `PATCH /api/v1/accounts/:id` — переименование счета.
- `POST /api/v1/accounts/:id/archive` — архивирование счета (требует баланс = 0.00).
- `GET /api/v1/accounts/balances` — получение балансов активных счетов.

**Бизнес-логика:**
- Расчет баланса на основе всех транзакций:
  - `OPENING_BALANCE` — прибавляется к балансу.
  - `INCOME` — прибавляется.
  - `EXPENSE` — вычитается.
  - `TRANSFER` — вычитается из from_account, прибавляется к to_account.
- Правило архивирования: баланс должен быть строго 0.00 (иначе 409 Conflict).

**DTOs:**
- `CreateAccountDto` — валидация при создании.
- `UpdateAccountDto` — валидация при обновлении.
- `AccountDto` — response DTO.
- `BalanceDto` — баланс счета с метаданными.

### 4. CategoriesModule (CRUD для категорий)

**Endpoints:**
- `GET /api/v1/categories?type=expense|income` — получение категорий с фильтрацией.
- `POST /api/v1/categories` — создание категории (с проверкой уникальности по normalized name).
- `PATCH /api/v1/categories/:id` — переименование категории (только для EXPENSE типа).

**Бизнес-логика:**
- Нормализация имен: `trim().toLowerCase()` для уникальности.
- Правило переименования: income-категории нельзя переименовывать (immutable).
- Проверка уникальности при создании и переименовании (409 Conflict при дубликате).

**DTOs:**
- `CreateCategoryDto` — валидация при создании.
- `UpdateCategoryDto` — валидация при обновлении.
- `CategoryDto` — response DTO.

### 5. Унифицированная обработка ошибок

- Реализован глобальный `HttpExceptionFilter`:
  - Ловит все исключения (не только HttpException).
  - Преобразует в `ErrorResponseDto` с полями: `code`, `message`, `details`.
  - Автоматический маппинг HTTP статусов в бизнес-коды.

**Специфичные error codes:**
- Accounts: `ACCOUNT_NOT_FOUND`, `ACCOUNT_BALANCE_NOT_ZERO`, `ACCOUNT_ALREADY_ARCHIVED`.
- Categories: `CATEGORY_ALREADY_EXISTS`, `CATEGORY_NOT_FOUND`, `INCOME_CATEGORY_IMMUTABLE`, `CATEGORY_NAME_CONFLICT`.

### 6. OpenAPI контракт

Обновлен `api/openapi/openapi.source.json`:
- Добавлены все CRUD операции для accounts и categories.
- Определены schemas: `AccountDto`, `CreateAccountDto`, `UpdateAccountDto`, `BalanceDto`, `CategoryDto`, `CreateCategoryDto`, `UpdateCategoryDto`.
- Документированы error responses для каждого endpoint.

### 7. Зависимости и build

- Добавлены зависимости: `class-validator`, `class-transformer`.
- Добавлены dev-зависимости: `@nestjs/testing`, `@types/express`, `tsx`.
- Настроены scripts:
  - `build` — генерация Prisma Client, OpenAPI, компиляция TypeScript.
  - `test` — запуск тестов через tsx.
  - `dev` — сборка и запуск.

### 8. Тестирование

- Добавлен baseline test для проверки сборки.
- Применена миграция Prisma к локальной БД.

## Верификация

- `pnpm --filter @moneykeeper/api run format` — ✅ код отформатирован.
- `pnpm --filter @moneykeeper/api run test` — ✅ baseline test проходит.
- `pnpm --filter @moneykeeper/api run build` — ✅ сборка успешна.

## ADR

- [ADR-0013: NestJS + TypeScript структура API с CRUD модулями](../ADR/ADR-0013-api-core-nestjs-typescript-structure.md)

## Технический долг

- Добавить поддержку TypeScript в ESLint конфиг (пока линтинг пропущен).
- Реализовать полноценные интеграционные/e2e тесты (требуется настройка тестовой БД для Prisma Client 7.x).
- Убрать `MOCK_USER_ID` из контроллеров после реализации auth module (AUTH-001).

## Следующие шаги

Задача готова к отметке выполненной в BACKLOG.md. Переход к API-003 (Transactions CRUD).
