# Задача API-003: Build transactions CRUD with type rules

**Статус**: ✅ Выполнено  
**Дата**: 2026-02-26

## Цель
Реализовать CRUD для транзакций (Expense/Income/Transfer) с правилами согласно PRD и TECHSPEC:
- Transfer не влияет на income/expense аналитику
- Поддержка даты/времени и account/category ссылок
- Корректные валидации и статус-коды ошибок

## Выполненные работы

### 1. Создана структура модуля
- `api/src/transactions/dto/transaction.dto.ts` — DTO с валидацией для разных типов транзакций
- `api/src/transactions/transactions.service.ts` — сервис с бизнес-логикой
- `api/src/transactions/transactions.controller.ts` — контроллер с endpoints
- `api/src/transactions/transactions.module.ts` — модуль NestJS
- `api/src/transactions/transactions.service.test.ts` — unit-тесты

### 2. Реализованные endpoints
- `GET /api/v1/transactions` — список транзакций с фильтрами и пагинацией
- `GET /api/v1/transactions/:id` — получение транзакции по ID
- `POST /api/v1/transactions` — создание транзакции
- `PATCH /api/v1/transactions/:id` — редактирование транзакции
- `POST /api/v1/transactions/:id/void` — отмена транзакции (VOID)

### 3. Реализованные бизнес-правила

#### EXPENSE/INCOME:
- ✅ Только RUB счета (валидация currency === 'RUB')
- ✅ Обязательная категория с matching типом (EXPENSE category для EXPENSE tx)
- ✅ Валидация существования account и category

#### TRANSFER:
- ✅ Запрет перевода на тот же счёт (fromAccountId !== toAccountId)
- ✅ Проверка валют: если same currency → amounts должны совпадать
- ✅ Поддержка разных amounts для разных валют
- ✅ Нельзя менять from/to accounts при редактировании

#### OPENING_BALANCE:
- ✅ Полностью иммутабельно (нельзя редактировать)
- ✅ Нельзя устанавливать VOID

#### Общие правила:
- ✅ Статус VOID нельзя применить повторно
- ✅ Корректные статус-коды ошибок (400, 404, 409)
- ✅ Специфичные коды ошибок (ONLY_RUB_ACCOUNTS_ALLOWED, CATEGORY_TYPE_MISMATCH, etc.)

### 4. Тесты
Реализованы unit-тесты с использованием Node.js test runner:
- ✅ Валидация RUB-only для EXPENSE/INCOME
- ✅ Валидация TRANSFER (same account, same currency amounts)
- ✅ Immutability OPENING_BALANCE
- ✅ Корректные error codes

**Результаты**: Все 4 теста проходят успешно.

### 5. OpenAPI контракт
Обновлен `api/openapi/openapi.source.json`:
- ✅ Добавлены все endpoints с полной спецификацией
- ✅ Обновлены schemas для поддержки всех типов транзакций
- ✅ Добавлен UpdateTransactionDto
- ✅ Корректные descriptions и error responses

## Принятые решения
Специальных архитектурных решений не требовалось — реализация следует установленным паттернам в проекте (AccountsModule, CategoriesModule).

## Зависимости
- Использует существующие:
  - `PrismaModule` для работы с БД
  - Prisma schema с Transaction entity (из API-001)
  - Global exception filter для error handling

## Ссылки на код
- DTO: `api/src/transactions/dto/transaction.dto.ts`
- Service: `api/src/transactions/transactions.service.ts`
- Controller: `api/src/transactions/transactions.controller.ts`
- Module: `api/src/transactions/transactions.module.ts`
- Tests: `api/src/transactions/transactions.service.test.ts`
- OpenAPI: `api/openapi/openapi.source.json` (paths /transactions, /transactions/{id}, /transactions/{id}/void)

## Результат
✅ Задача полностью выполнена согласно Definition of Done:
- CRUD и валидации работают корректно
- Есть тесты бизнес-правил по типам транзакций
- Корректные статус-коды ошибок
- Код компилируется без ошибок
- Все тесты проходят
