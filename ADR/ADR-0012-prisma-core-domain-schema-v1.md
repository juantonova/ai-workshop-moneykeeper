# ADR-0012: Начальная Prisma-схема core-домена (API-001)

## Статус

Принято

## Контекст

Для перехода к Stage 2 требуется единый источник доменной структуры данных в `api` с воспроизводимыми миграциями.
Требования из `TECHSPEC.md` и `PRD.MD` задают:

- single-user модель;
- core-сущности `User`, `Account`, `Category`, `Transaction`, `RefreshSession`;
- строгие связи между сущностями и поддержка будущих auth/snapshot сценариев;
- индексируемые выборки под history/filter API.

## Решение

1. Принять Prisma + SQLite как слой описания и миграций доменной модели в `api`.
2. Реализовать в `api/prisma/schema.prisma`:
   - таблицы: `users`, `refresh_sessions`, `accounts`, `categories`, `transactions`;
   - enum-типы домена: валюты, типы счетов, типы категорий, типы/статусы транзакций;
   - связи через FK с `ON DELETE CASCADE` для user-owned данных и `ON DELETE RESTRICT` для ссылочных сущностей транзакций.
3. Зафиксировать доменные ограничения уровня схемы:
   - уникальность `users.telegram_user_id`;
   - single active refresh-session через `UNIQUE(refresh_sessions.user_id)`;
   - уникальность категории по `(user_id, type, normalized_name)`.
4. Добавить индексы под основные сценарии чтения:
   - history по `user_id + occurred_at_utc`;
   - фильтрация по `type/status` в диапазонах дат;
   - выборки по связям account/category.

## Последствия

- Плюсы:
  - воспроизводимые миграции и предсказуемая эволюция схемы;
  - готовая база для API CRUD, auth-сессий и последующих snapshot-модулей;
  - ранняя фиксация ключевых инвариантов на уровне БД.
- Минусы:
  - часть бизнес-правил (например, тип-специфичные обязательные поля транзакций) пока не enforce-ится CHECK-constraint-ами и будет добавляться на уровне сервисов/валидации в следующих задачах.
